<Page
    x:Class="DMusicPakCreator.Views.CreatorPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Grid x:Name="ContentArea">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- 顶部工具栏 -->
        <Grid Grid.Row="0" Background="{ThemeResource LayerFillColorDefaultBrush}" Padding="12,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                <Button Click="NewPackage_Click" ToolTipService.ToolTip="新建 (Ctrl+N)">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE7C3;" FontSize="16" />
                        <TextBlock Text="新建" />
                    </StackPanel>
                </Button>
                <Button Click="OpenPackage_Click" ToolTipService.ToolTip="打开 (Ctrl+O)">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE8E5;" FontSize="16" />
                        <TextBlock Text="打开" />
                    </StackPanel>
                </Button>
                <Button x:Name="SaveButton" Click="SavePackage_Click" IsEnabled="False" ToolTipService.ToolTip="保存 (Ctrl+S)">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE74E;" FontSize="16" />
                        <TextBlock Text="保存" />
                    </StackPanel>
                </Button>
                <Button x:Name="SaveAsButton" Click="SavePackageAs_Click" IsEnabled="False">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE792;" FontSize="16" />
                        <TextBlock Text="另存为" />
                    </StackPanel>
                </Button>
            </StackPanel>

            <TextBlock x:Name="StatusText"
                       Grid.Column="1"
                       Text="就绪"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Center"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />

            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                <Button x:Name="PlayPauseButton"
                        Click="PlayPauseButton_Click"
                        IsEnabled="False"
                        ToolTipService.ToolTip="播放/暂停 (Space)">
                    <FontIcon x:Name="PlayPauseIcon" Glyph="&#xE768;" FontSize="20" />
                </Button>
                <TextBlock x:Name="TimeDisplay"
                           Text="00:00 / 00:00"
                           VerticalAlignment="Center"
                           MinWidth="100"
                           TextAlignment="Center" />
            </StackPanel>
        </Grid>

        <!-- 信息栏 -->
        <InfoBar x:Name="InfoBar"
                 Grid.Row="1"
                 IsOpen="False"
                 IsClosable="True"
                 Margin="12,0,12,0" />

        <!-- 主内容区 - 使用 Pivot -->
        <Pivot Grid.Row="2" Margin="12">

            <!-- 基本信息标签页 -->
            <PivotItem Header="基本信息" Margin="0,12,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" MaxWidth="800" />
                        <ColumnDefinition Width="16" />
                        <ColumnDefinition Width="300" />
                    </Grid.ColumnDefinitions>

                    <!-- 左侧：元数据表单 -->
                    <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto">
                        <StackPanel Spacing="16">

                            <!-- 音频文件卡片 -->
                            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Padding="20"
                                    AllowDrop="True"
                                    DragOver="AudioDrop_DragOver"
                                    Drop="AudioDrop_Drop">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <TextBlock Text="音频文件"
                                               FontSize="18"
                                               FontWeight="SemiBold"
                                               Margin="0,0,0,16" />

                                    <Grid Grid.Row="1" x:Name="AudioEmptyState" Visibility="Visible">
                                        <StackPanel Spacing="12" HorizontalAlignment="Center" Padding="40,20">
                                            <FontIcon Glyph="&#xE8D6;"
                                                      FontSize="48"
                                                      Foreground="{ThemeResource AccentFillColorDefaultBrush}" />
                                            <TextBlock Text="拖拽音频文件到此处"
                                                       FontSize="16"
                                                       HorizontalAlignment="Center" />
                                            <TextBlock Text="或点击下方按钮选择文件"
                                                       FontSize="12"
                                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                       HorizontalAlignment="Center" />
                                            <HyperlinkButton Content="支持格式: MP3, FLAC, WAV, OGG, M4A, AAC"
                                                             HorizontalAlignment="Center"
                                                             FontSize="11" />
                                        </StackPanel>
                                    </Grid>

                                    <Grid Grid.Row="1" x:Name="AudioInfoState" Visibility="Collapsed">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <Border Grid.Column="0"
                                                    Background="{ThemeResource AccentFillColorDefaultBrush}"
                                                    CornerRadius="4"
                                                    Padding="12"
                                                    VerticalAlignment="Center">
                                                <FontIcon Glyph="&#xE8D6;" FontSize="32" Foreground="White" />
                                            </Border>

                                            <StackPanel Grid.Column="1" Margin="16,0,0,0" VerticalAlignment="Center">
                                                <TextBlock x:Name="AudioFileNameText"
                                                           Text="未导入"
                                                           FontSize="16"
                                                           FontWeight="SemiBold"
                                                           TextTrimming="CharacterEllipsis" />
                                                <TextBlock x:Name="AudioSizeText"
                                                           Text="0 KB"
                                                           FontSize="12"
                                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                           Margin="0,4,0,0" />
                                            </StackPanel>

                                            <Button Grid.Column="2"
                                                    Content="更换"
                                                    Click="ImportAudio_Click"
                                                    VerticalAlignment="Center" />
                                        </Grid>
                                    </Grid>

                                    <Button Grid.Row="2"
                                            x:Name="ImportAudioButton"
                                            Content="选择音频文件"
                                            Click="ImportAudio_Click"
                                            HorizontalAlignment="Stretch"
                                            Margin="0,16,0,0"
                                            Style="{StaticResource AccentButtonStyle}" />
                                </Grid>
                            </Border>

                            <!-- 元数据卡片 -->
                            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Padding="20">
                                <StackPanel Spacing="12">
                                    <TextBlock Text="音乐信息"
                                               FontSize="18"
                                               FontWeight="SemiBold"
                                               Margin="0,0,0,8" />

                                    <TextBox x:Name="TitleBox"
                                             Header="歌曲标题"
                                             PlaceholderText="请输入歌曲标题"
                                             TextChanged="OnFormChanged" />

                                    <TextBox x:Name="ArtistBox"
                                             Header="艺术家"
                                             PlaceholderText="请输入艺术家名称"
                                             TextChanged="OnFormChanged" />

                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="12" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <TextBox x:Name="AlbumBox"
                                                 Grid.Column="0"
                                                 Header="专辑"
                                                 PlaceholderText="专辑名称"
                                                 TextChanged="OnFormChanged" />

                                        <TextBox x:Name="YearBox"
                                                 Grid.Column="2"
                                                 Header="年份"
                                                 PlaceholderText="2025"
                                                 TextChanged="OnFormChanged" />
                                    </Grid>

                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="12" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <TextBox x:Name="GenreBox"
                                                 Grid.Column="0"
                                                 Header="流派"
                                                 PlaceholderText="流行/摇滚..."
                                                 TextChanged="OnFormChanged" />

                                        <TextBox x:Name="DurationBox"
                                                 Grid.Column="2"
                                                 Header="时长 (毫秒)"
                                                 PlaceholderText="自动识别"
                                                 IsReadOnly="True" />
                                    </Grid>

                                    <TextBox x:Name="CommentBox"
                                             Header="备注"
                                             PlaceholderText="其他信息..."
                                             AcceptsReturn="True"
                                             Height="80"
                                             TextChanged="OnFormChanged" />
                                </StackPanel>
                            </Border>

                            <!-- 技术参数卡片 -->
                            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Padding="20">
                                <StackPanel Spacing="12">
                                    <TextBlock Text="音频参数"
                                               FontSize="18"
                                               FontWeight="SemiBold"
                                               Margin="0,0,0,8" />

                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="12" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="12" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <TextBox x:Name="BitrateBox"
                                                 Grid.Column="0"
                                                 Header="比特率 (kbps)"
                                                 PlaceholderText="320"
                                                 IsReadOnly="True" />

                                        <TextBox x:Name="SampleRateBox"
                                                 Grid.Column="2"
                                                 Header="采样率 (Hz)"
                                                 PlaceholderText="44100"
                                                 IsReadOnly="True" />

                                        <TextBox x:Name="ChannelsBox"
                                                 Grid.Column="4"
                                                 Header="声道"
                                                 PlaceholderText="2"
                                                 IsReadOnly="True" />
                                    </Grid>
                                </StackPanel>
                            </Border>

                        </StackPanel>
                    </ScrollViewer>

                    <!-- 右侧：封面预览 -->
                    <Border Grid.Column="2"
                            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            CornerRadius="8"
                            Padding="20"
                            AllowDrop="True"
                            DragOver="CoverDrop_DragOver"
                            Drop="CoverDrop_Drop">
                        <StackPanel Spacing="16">
                            <TextBlock Text="专辑封面"
                                       FontSize="18"
                                       FontWeight="SemiBold" />

                            <Border BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Background="{ThemeResource LayerFillColorDefaultBrush}"
                                    Height="300">
                                <Grid>
                                    <StackPanel x:Name="CoverEmptyState"
                                                Spacing="12"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                Visibility="Visible">
                                        <FontIcon Glyph="&#xEB9F;"
                                                  FontSize="48"
                                                  Foreground="{ThemeResource AccentFillColorDefaultBrush}"
                                                  HorizontalAlignment="Center" />
                                        <TextBlock Text="无封面"
                                                   FontSize="14"
                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                   HorizontalAlignment="Center" />
                                        <TextBlock Text="拖拽图片到此处"
                                                   FontSize="11"
                                                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                                   HorizontalAlignment="Center" />
                                    </StackPanel>

                                    <Image x:Name="CoverImage"
                                           Stretch="Uniform"
                                           Visibility="Collapsed" />
                                </Grid>
                            </Border>

                            <TextBlock x:Name="CoverInfoText"
                                       Text=""
                                       FontSize="11"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                       HorizontalAlignment="Center"
                                       TextAlignment="Center" />

                            <StackPanel Spacing="8">
                                <Button Content="选择封面图片"
                                        Click="ImportCover_Click"
                                        HorizontalAlignment="Stretch" />
                                <Button x:Name="RemoveCoverButton"
                                        Content="移除封面"
                                        Click="RemoveCover_Click"
                                        HorizontalAlignment="Stretch"
                                        IsEnabled="False" />
                            </StackPanel>

                            <TextBlock Text="支持格式: JPG, PNG, WebP, BMP"
                                       FontSize="10"
                                       Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                       TextWrapping="Wrap"
                                       HorizontalAlignment="Center"
                                       TextAlignment="Center" />
                        </StackPanel>
                    </Border>
                </Grid>
            </PivotItem>

            <!-- 歌词标签页 - 修复版 -->
            <PivotItem Header="歌词" Margin="0,12,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" MaxWidth="600" />
                        <ColumnDefinition Width="16" />
                        <ColumnDefinition Width="350" />
                    </Grid.ColumnDefinitions>

                    <!-- 左侧：歌词编辑器 -->
                    <Border Grid.Column="0"
                            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            CornerRadius="8"
                            Padding="20">
                        <StackPanel Spacing="16">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="16" />
                                    <ColumnDefinition Width="200" />
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0"
                                           Text="歌词编辑"
                                           FontSize="18"
                                           FontWeight="SemiBold"
                                           VerticalAlignment="Center" />

                                <ComboBox x:Name="LyricsFormatCombo"
                                          Grid.Column="2"
                                          Header="格式"
                                          HorizontalAlignment="Stretch"
                                          SelectedIndex="0"
                                          SelectionChanged="LyricsFormatCombo_SelectionChanged">
                                    <ComboBoxItem Content="无" />
                                    <ComboBoxItem Content="LRC ESLyric" />
                                    <ComboBoxItem Content="LRC 逐字" />
                                    <ComboBoxItem Content="LRC 逐行" />
                                    <ComboBoxItem Content="SRT" />
                                    <ComboBoxItem Content="ASS/SSA" />
                                </ComboBox>
                            </Grid>

                            <TextBox x:Name="LyricsBox"
                                     PlaceholderText="在此输入或粘贴歌词...&#x0a;&#x0a;LRC 格式示例：&#x0a;[00:12.00]第一句歌词&#x0a;[00:17.20]第二句歌词"
                                     AcceptsReturn="True"
                                     Height="500"
                                     TextWrapping="Wrap"
                                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                                     FontFamily="Consolas"
                                     FontSize="13"
                                     TextChanged="OnFormChanged" />

                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Button Content="从文件导入" Click="ImportLyrics_Click" />
                                <Button Content="清空歌词" Click="ClearLyrics_Click" />
                            </StackPanel>

                            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Padding="16">
                                <StackPanel Spacing="8">
                                    <TextBlock Text="💡 提示" FontWeight="SemiBold" />
                                    <TextBlock Text="• LRC 格式时间标签格式: [mm:ss.xx]"
                                               FontSize="12"
                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                    <TextBlock Text="• SRT 格式需包含序号、时间轴和文本"
                                               FontSize="12"
                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                    <TextBlock Text="• 支持从 .lrc, .srt, .ass 文件导入"
                                               FontSize="12"
                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Border>

                    <!-- 右侧：歌词预览 -->
                    <Border Grid.Column="2"
                            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            CornerRadius="8"
                            Padding="20">
                        <StackPanel Spacing="16">
                            <TextBlock Text="歌词预览"
                                       FontSize="18"
                                       FontWeight="SemiBold" />

                            <Border BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Background="{ThemeResource LayerFillColorDefaultBrush}"
                                    Height="550">
                                <ScrollViewer x:Name="LyricsScrollViewer" 
                                              VerticalScrollBarVisibility="Auto"
                                              Padding="12">
                                    <StackPanel x:Name="LyricsPreviewPanel" Spacing="8">
                                        <TextBlock Text="无歌词"
                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"
                                                   Margin="0,200,0,0" />
                                    </StackPanel>
                                </ScrollViewer>
                            </Border>

                            <TextBlock x:Name="CurrentLyricTimeText"
                                       Text="--:--"
                                       FontSize="12"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                       HorizontalAlignment="Center" />
                        </StackPanel>
                    </Border>
                </Grid>
            </PivotItem>

        </Pivot>
    </Grid>
</Page>