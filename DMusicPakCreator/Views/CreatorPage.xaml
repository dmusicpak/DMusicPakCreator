<Page
    x:Class="DMusicPakCreator.Views.CreatorPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:converters="using:DMusicPakCreator.Converters"
    mc:Ignorable="d">

    <Page.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:StringNullOrEmptyToVisibilityConverter x:Key="StringToVisibilityConverter" />

        <!-- 动画资源 -->
        <Storyboard x:Name="FadeInStoryboard">
            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                           From="0" To="1" Duration="0:0:0.3">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
    </Page.Resources>

    <Grid x:Name="ContentArea">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- 顶部工具栏 -->
        <Border Grid.Row="0" 
                Background="{ThemeResource LayerFillColorDefaultBrush}" 
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                CornerRadius="5"
                BorderThickness="0,0,0,1"
                Padding="10,1"
                Height="50">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- 左侧按钮组 -->
                <CommandBar Grid.Column="0" DefaultLabelPosition="Right" Background="Transparent" VerticalAlignment="Center">
                    <AppBarButton Icon="Page" Label="新建" Click="NewPackage_Click" ToolTipService.ToolTip="Ctrl+N"/>
                    <AppBarButton Icon="OpenFile" Label="打开" Click="OpenPackage_Click" ToolTipService.ToolTip="Ctrl+O"/>
                    <AppBarSeparator/>
                    <AppBarButton Icon="Save" Label="保存" 
                                IsEnabled="{x:Bind ViewModel.IsModified, Mode=OneWay}"
                                Click="SavePackage_Click" 
                                ToolTipService.ToolTip="Ctrl+S"/>
                    <AppBarButton Icon="SaveLocal" Label="另存为" 
                                IsEnabled="{x:Bind ViewModel.HasAudio, Mode=OneWay}"
                                Click="SavePackageAs_Click"/>
                </CommandBar>

                <!-- 中央状态栏 -->
                <StackPanel Grid.Column="1" 
                          Orientation="Horizontal" 
                          
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center">
                    <FontIcon Glyph="&#xE9F3;" FontSize="14" 
                            Foreground="{ThemeResource AccentFillColorDefaultBrush}"
                            Visibility="{x:Bind ViewModel.IsModified, Mode=OneWay}"/>
                    <TextBlock Text="{x:Bind ViewModel.StatusText, Mode=OneWay}"
                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                             VerticalAlignment="Center"/>
                </StackPanel>

                <!-- 右侧播放控制 -->
                <StackPanel Grid.Column="2" 
                          Orientation="Horizontal" 
                         
                          VerticalAlignment="Center">
                    <TextBlock Text="{x:Bind ViewModel.PlaybackTime, Mode=OneWay}"
                             VerticalAlignment="Center"
                             MinWidth="120"
                             TextAlignment="Center"
                             FontFamily="Consolas"/>
                    <AppBarButton 
                        IsEnabled="{x:Bind ViewModel.CanPlay, Mode=OneWay}"
                        VerticalAlignment="Center"
                        Click="PlayPauseButton_Click"
                        ToolTipService.ToolTip="空格键播放/暂停">
                        <AppBarButton.Icon>
                            <FontIcon Glyph="{x:Bind GetPlayPauseGlyph(ViewModel.IsPlaying), Mode=OneWay}" />
                        </AppBarButton.Icon>
                    </AppBarButton>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 信息栏 -->
        <InfoBar x:Name="InfoBar"
                 Grid.Row="1"
                 IsOpen="False"
                 IsClosable="True"
                 Margin="16,8,16,0" />

        <!-- 主内容区 - Pivot -->
        <Pivot Grid.Row="2" Margin="0,16,0,0">

            <!-- 基本信息标签页 -->
            <PivotItem Header="📝 基本信息">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16,12,16,24">
                    <StackPanel HorizontalAlignment="Stretch" Spacing="20">

                        <!-- 音频和封面卡片 -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="20" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <!-- 音频导入区 -->
                            <Border Grid.Column="0"
                                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Padding="24"
                                    AllowDrop="True"
                                    DragOver="AudioDrop_DragOver"
                                    Drop="AudioDrop_Drop">
                                <StackPanel Spacing="16">
                                    <TextBlock Text="🎵 音频文件"
                                             FontSize="20"
                                             FontWeight="SemiBold" />

                                    <!-- 空状态 -->
                                    <Border Visibility="{x:Bind ViewModel.HasAudio, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}"
                                            BorderBrush="{ThemeResource AccentFillColorDefaultBrush}"
                                            BorderThickness="2"
                                            CornerRadius="8"
                                            Background="{ThemeResource LayerFillColorDefaultBrush}"
                                            Padding="32"
                                            MinHeight="180">
                                        <StackPanel Spacing="16" HorizontalAlignment="Center" VerticalAlignment="Center">
                                            <FontIcon Glyph="&#xE8D6;"
                                                    FontSize="56"
                                                    Foreground="{ThemeResource AccentFillColorDefaultBrush}" />
                                            <TextBlock Text="拖拽音频文件到此处"
                                                     FontSize="16"
                                                     FontWeight="SemiBold"
                                                     HorizontalAlignment="Center" />
                                            <TextBlock TextAlignment="Center"
                                                     Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                                                <Run Text="支持格式: "/>
                                                <Run Text="MP3, FLAC, WAV, OGG, M4A, AAC" FontWeight="SemiBold"/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>

                                    <!-- 已导入状态 -->
                                    <Border Visibility="{x:Bind ViewModel.HasAudio, Mode=OneWay}"
                                            Background="{ThemeResource LayerFillColorDefaultBrush}"
                                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                            BorderThickness="1"
                                            CornerRadius="8"
                                            Padding="20">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>

                                            <Border Background="{ThemeResource AccentFillColorDefaultBrush}"
                                                  CornerRadius="8"
                                                  Width="64" Height="64"
                                                  VerticalAlignment="Center">
                                                <FontIcon Glyph="&#xE8D6;" 
                                                        FontSize="32" 
                                                        Foreground="White" />
                                            </Border>

                                            <StackPanel Grid.Column="1" 
                                                      Margin="16,0,0,0" 
                                                      VerticalAlignment="Center"
                                                      Spacing="8">
                                                <TextBlock Text="{x:Bind ViewModel.AudioFileName, Mode=OneWay}"
                                                         FontSize="16"
                                                         FontWeight="SemiBold"
                                                         TextTrimming="CharacterEllipsis" />
                                                <TextBlock Text="{x:Bind ViewModel.AudioFileSize, Mode=OneWay}"
                                                         FontSize="13"
                                                         Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                            </StackPanel>
                                        </Grid>
                                    </Border>

                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8">
                                        <Button Content="选择文件"
                                              Click="ImportAudio_Click"
                                              Style="{StaticResource AccentButtonStyle}"
                                              Visibility="{x:Bind ViewModel.HasAudio, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}">
                                            <Button.KeyboardAccelerators>
                                                <KeyboardAccelerator Key="I" Modifiers="Control"/>
                                            </Button.KeyboardAccelerators>
                                        </Button>
                                        <Button Content="更换音频"
                                              Click="ImportAudio_Click"
                                              Visibility="{x:Bind ViewModel.HasAudio, Mode=OneWay}"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- 封面区 -->
                            <Border Grid.Column="2"
                                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Padding="24"
                                    AllowDrop="True"
                                    DragOver="CoverDrop_DragOver"
                                    Drop="CoverDrop_Drop">
                                <StackPanel Spacing="16">
                                    <TextBlock Text="🎨 专辑封面"
                                             FontSize="20"
                                             FontWeight="SemiBold" />

                                    <!-- 封面预览 -->
                                    <Border BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                            BorderThickness="1"
                                            CornerRadius="8"
                                            Background="{ThemeResource LayerFillColorDefaultBrush}"
                                            Height="280"
                                            Width="280">
                                        <Grid>
                                            <!-- 空状态 -->
                                            <StackPanel Spacing="12"
                                                      HorizontalAlignment="Center"
                                                      VerticalAlignment="Center"
                                                      Visibility="{x:Bind ViewModel.HasCover, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}">
                                                <FontIcon Glyph="&#xEB9F;"
                                                        FontSize="56"
                                                        Foreground="{ThemeResource TextFillColorTertiaryBrush}" />
                                                <TextBlock Text="无封面"
                                                         FontSize="14"
                                                         Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                            </StackPanel>

                                            <!-- 封面图片 -->
                                            <Image Source="{x:Bind ViewModel.CoverImage, Mode=OneWay}"
                                                 Stretch="Uniform"
                                                 Visibility="{x:Bind ViewModel.HasCover, Mode=OneWay}" />
                                        </Grid>
                                    </Border>

                                    <TextBlock Text="{x:Bind ViewModel.CoverInfo, Mode=OneWay}"
                                             FontSize="11"
                                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                             TextAlignment="Center"
                                             TextWrapping="Wrap"
                                             Visibility="{x:Bind ViewModel.HasCover, Mode=OneWay}"/>

                                    <Grid ColumnSpacing="8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Button Content="选择"
                                              Grid.Column="0"
                                              Click="ImportCover_Click"
                                              HorizontalAlignment="Stretch"/>
                                        <Button Content="移除"
                                              Grid.Column="1"
                                              Click="RemoveCover_Click"
                                              IsEnabled="{x:Bind ViewModel.HasCover, Mode=OneWay}"
                                              HorizontalAlignment="Stretch"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </Grid>

                        <!-- 元数据卡片 -->
                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="24">
                            <StackPanel Spacing="16">
                                <TextBlock Text="📋 音乐信息"
                                         FontSize="20"
                                         FontWeight="SemiBold" />

                                <Grid RowSpacing="16" ColumnSpacing="16">
                                    <Grid.RowDefinitions>
                                        <RowDefinition/>
                                        <RowDefinition/>
                                        <RowDefinition/>
                                        <RowDefinition/>
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBox Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
                                           Header="歌曲标题"
                                           PlaceholderText="请输入歌曲标题"
                                           Text="{x:Bind ViewModel.Title, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBox Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                           Header="艺术家"
                                           PlaceholderText="请输入艺术家名称"
                                           Text="{x:Bind ViewModel.Artist, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBox Grid.Row="2" Grid.Column="0"
                                           Header="专辑"
                                           PlaceholderText="专辑名称"
                                           Text="{x:Bind ViewModel.Album, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBox Grid.Row="2" Grid.Column="1"
                                           Header="年份"
                                           PlaceholderText="2025"
                                           Text="{x:Bind ViewModel.Year, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBox Grid.Row="3" Grid.Column="0"
                                           Header="流派"
                                           PlaceholderText="流行/摇滚..."
                                           Text="{x:Bind ViewModel.Genre, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBox Grid.Row="3" Grid.Column="1"
                                           Header="时长 (毫秒)"
                                           PlaceholderText="自动识别"
                                           Text="{x:Bind ViewModel.Duration, Mode=OneWay}"
                                           IsReadOnly="True" />
                                </Grid>

                                <TextBox Header="备注"
                                       PlaceholderText="其他信息..."
                                       AcceptsReturn="True"
                                       Height="100"
                                       TextWrapping="Wrap"
                                       Text="{x:Bind ViewModel.Comment, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>
                        </Border>

                        <!-- 技术参数卡片 -->
                        <Expander Header="⚙️ 音频参数" 
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Stretch">
                            <Grid Padding="16" ColumnSpacing="16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <TextBox Grid.Column="0"
                                       Header="比特率 (kbps)"
                                       Text="{x:Bind ViewModel.Bitrate, Mode=OneWay}"
                                       IsReadOnly="True" />

                                <TextBox Grid.Column="1"
                                       Header="采样率 (Hz)"
                                       Text="{x:Bind ViewModel.SampleRate, Mode=OneWay}"
                                       IsReadOnly="True" />

                                <TextBox Grid.Column="2"
                                       Header="声道数"
                                       Text="{x:Bind ViewModel.Channels, Mode=OneWay}"
                                       IsReadOnly="True" />
                            </Grid>
                        </Expander>

                    </StackPanel>
                </ScrollViewer>
            </PivotItem>

            <!-- 歌词标签页 -->
            <PivotItem Header="🎤 歌词">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16,12,16,24">
                    <StackPanel HorizontalAlignment="Stretch" Spacing="20">

                        <!-- 歌词编辑器 -->
                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="24">
                            <StackPanel Spacing="16">
                                <Grid>
                                    <TextBlock Text="✏️ 歌词编辑"
                                             FontSize="20"
                                             FontWeight="SemiBold"
                                             VerticalAlignment="Center" />

                                    <ComboBox HorizontalAlignment="Right"
                                            Header="格式"
                                            MinWidth="180"
                                            SelectedIndex="{x:Bind GetLyricFormatIndex(ViewModel.LyricsFormat), Mode=OneWay}"
                                            SelectionChanged="LyricsFormatCombo_SelectionChanged">
                                        <ComboBoxItem Content="无歌词" />
                                        <ComboBoxItem Content="LRC ESLyric" />
                                        <ComboBoxItem Content="LRC 逐字" />
                                        <ComboBoxItem Content="LRC 逐行" />
                                        <ComboBoxItem Content="SRT 字幕" />
                                        <ComboBoxItem Content="ASS/SSA" />
                                    </ComboBox>
                                </Grid>

                                <TextBox x:Name="LyricsBox"
                                       PlaceholderText="在此输入或粘贴歌词...&#x0a;&#x0a;LRC 格式示例：&#x0a;[00:12.00]第一句歌词&#x0a;[00:17.20]第二句歌词"
                                       AcceptsReturn="True"
                                       Height="400"
                                       TextWrapping="Wrap"
                                       ScrollViewer.VerticalScrollBarVisibility="Auto"
                                       FontFamily="Consolas"
                                       FontSize="14"
                                       Text="{x:Bind ViewModel.LyricsText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                                <Grid ColumnSpacing="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Button Grid.Column="0" Click="ImportLyrics_Click">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon Glyph="&#xE8E5;" FontSize="14"/>
                                            <TextBlock Text="从文件导入"/>
                                        </StackPanel>
                                    </Button>
                                    <Button Grid.Column="1" Click="ClearLyrics_Click">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon Glyph="&#xE74D;" FontSize="14"/>
                                            <TextBlock Text="清空"/>
                                        </StackPanel>
                                    </Button>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- 歌词预览 -->
                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="24">
                            <StackPanel Spacing="16">
                                <Grid>
                                    <TextBlock Text="👁️ 歌词预览"
                                             FontSize="20"
                                             FontWeight="SemiBold"
                                             VerticalAlignment="Center" />
                                    <TextBlock x:Name="CurrentLyricTimeText"
                                             Text="--:--"
                                             FontSize="13"
                                             FontFamily="Consolas"
                                             Foreground="{ThemeResource AccentFillColorDefaultBrush}"
                                             HorizontalAlignment="Right"
                                             VerticalAlignment="Center" />
                                </Grid>

                                <Border BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                        BorderThickness="1"
                                        CornerRadius="8"
                                        Background="{ThemeResource LayerFillColorDefaultBrush}"
                                        Height="450">
                                    <ScrollViewer x:Name="LyricsScrollViewer"
                                                VerticalScrollBarVisibility="Auto"
                                                Padding="20">
                                        <StackPanel x:Name="LyricsPreviewPanel" Spacing="12">
                                            <TextBlock Text="无歌词"
                                                     Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                                     HorizontalAlignment="Center"
                                                     VerticalAlignment="Center"
                                                     Margin="0,180,0,0"
                                                     FontSize="16" />
                                        </StackPanel>
                                    </ScrollViewer>
                                </Border>
                            </StackPanel>
                        </Border>

                    </StackPanel>
                </ScrollViewer>
            </PivotItem>

        </Pivot>

        <!-- 底部状态栏 -->
        <Border Grid.Row="3"
                Background="{ThemeResource LayerFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,8">
            <Grid>
                <TextBlock HorizontalAlignment="Left" 
                         VerticalAlignment="Center"
                         FontSize="12"
                         Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                    <Run Text="DMusicPak Creator"/>
                    <Run Text=" • "/>
                    <Run Text="{x:Bind ViewModel.WindowTitle, Mode=OneWay}"/>
                </TextBlock>
                
                <StackPanel Orientation="Horizontal" 
                          HorizontalAlignment="Right"
                          Spacing="16">
                    <TextBlock VerticalAlignment="Center"
                             FontSize="12"
                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                             Visibility="{x:Bind ViewModel.HasAudio, Mode=OneWay}">
                        <Run Text="音频:"/>
                        <Run Text="{x:Bind ViewModel.AudioFileName, Mode=OneWay}" FontWeight="SemiBold"/>
                    </TextBlock>
                    <TextBlock VerticalAlignment="Center"
                             FontSize="12"
                             Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                             Visibility="{x:Bind ViewModel.HasCover, Mode=OneWay}">
                        <Run Text="封面: ✓"/>
                    </TextBlock>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Page>